#!/bin/sh -ex
: ${HTML_DIR:=/data/html}
: ${BIN_DIR:=/data/bin}
: ${SRC_DIR:=/data/src}

if ! test -d $SRC_DIR/.git; then
    git clone https://github.com/elves/elvish $SRC_DIR
fi

(
cd $SRC_DIR
git restore .
git pull --ff-only
make -C ./website PUBLISH_DIR=$HTML_DIR/ -B publish
./tools/buildall.sh . $BIN_DIR `git describe --tags --always` HEAD
)
`dirname $0`/update-index
