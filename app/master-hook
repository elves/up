#!/bin/sh -ex
: ${SRC_DIR:=/data/src}
: ${HTML_DIR:=/data/html}
: ${BIN_DIR:=/data/bin}

if ! test -d $SRC_DIR/.git; then
    git clone https://github.com/elves/elvish $SRC_DIR
fi

(
cd $SRC_DIR
git restore .
git pull --ff-only

# Disable CGo when building website toolchain
export CGO_ENABLED=0
# Website
make -C ./website PUBLISH_DIR=$HTML_DIR/ -B publish
git show -s --format=%ct HEAD > $HTML_DIR/commit-ts.txt
# Docset
make -C ./website docset
mkdir $HTML_DIR/ref/docset
tar -C ./website -cvzf $HTML_DIR/ref/docset/Elvish.tgz Elvish.docset
cat > $HTML_DIR/ref/docset/Elvish.xml <<EOF
<entry>
  <version>$(date +%Y-%m-%d)-$(git rev-parse HEAD)</version>
  <url>https://elv.sh/ref/docset/Elvish.tgz</url>
</entry>
EOF
# Binaries
ELVISH_BUILD_VARIANT=official ./tools/buildall.sh . $BIN_DIR HEAD
)
`dirname $0`/update-index
